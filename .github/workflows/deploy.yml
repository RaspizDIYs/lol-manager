name: Deploy Releases

on:
  push:
    branches:
      - master
      - develop

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  deploy:
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Version and Validate
        id: get-version
        shell: bash
        run: |
          set -e  # Exit on any error
          
          # –í–∞–ª–∏–¥–∏—Ä—É–µ–º —á—Ç–æ .csproj —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–µ—Ä—Å–∏—é
          if ! grep -q '<Version>' LolManager.csproj; then
            echo "‚ùå ERROR: No <Version> tag found in LolManager.csproj"
            exit 1
          fi
          
          CURRENT_VERSION=$(grep -oE '<Version>[^<]+' LolManager.csproj | sed 's/<Version>//')
          echo "Current version in csproj: $CURRENT_VERSION"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–µ—Ä—Å–∏—è –≤–∞–ª–∏–¥–Ω–∞ (—Ñ–æ—Ä–º–∞—Ç X.Y.Z)
          if ! [[ "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå ERROR: Invalid version format in csproj: $CURRENT_VERSION (expected: X.Y.Z)"
            exit 1
          fi
          
          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            # –î–ª—è master –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–µ—Ä—Å–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
            echo "Checking if version was updated for stable release..."
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
            echo "Fetching latest stable release from GitHub API..."
            
            API_RESPONSE=$(curl -s -w "HTTP_STATUS:%{http_code}" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases")
            
            HTTP_STATUS=$(echo "$API_RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
            RESPONSE_BODY=$(echo "$API_RESPONSE" | sed '/HTTP_STATUS:/d')
            
            if [ "$HTTP_STATUS" != "200" ]; then
              echo "‚ùå ERROR: GitHub API request failed with status $HTTP_STATUS"
              echo "Response: $RESPONSE_BODY"
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ jq –¥–æ—Å—Ç—É–ø–µ–Ω
            if ! command -v jq &> /dev/null; then
              echo "‚ùå ERROR: jq is not installed"
              exit 1
            fi
            
            LAST_RELEASE=$(echo "$RESPONSE_BODY" | jq -r '[.[] | select(.prerelease == false)][0].tag_name // "v0.0.0"')
            
            if [ "$?" != "0" ]; then
              echo "‚ùå ERROR: Failed to parse GitHub API response with jq"
              exit 1
            fi
            
            LAST_VERSION=${LAST_RELEASE#v}
            echo "Last stable release version: $LAST_VERSION"
            
            if [ "$CURRENT_VERSION" == "$LAST_VERSION" ]; then
              echo "‚ùå ERROR: Version in csproj ($CURRENT_VERSION) matches last release ($LAST_VERSION)"
              echo "Please update version in LolManager.csproj before pushing to master"
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –±–æ–ª—å—à–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π
            if ! printf '%s\n%s\n' "$LAST_VERSION" "$CURRENT_VERSION" | sort -V -C; then
              echo "‚ùå ERROR: New version ($CURRENT_VERSION) is not greater than last version ($LAST_VERSION)"
              exit 1
            fi
            
            echo "‚úÖ Version check passed: $CURRENT_VERSION > $LAST_VERSION"
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            
          else
            # –î–ª—è develop –¥–æ–±–∞–≤–ª—è–µ–º prerelease —Å—É—Ñ—Ñ–∏–∫—Å (SemVer2 —Å–æ–≤–º–µ—Å—Ç–∏–º–æ)
            echo "Generating develop version with prerelease suffix..."
            
            DEVELOP_COMMIT_COUNT=$(git rev-list --count HEAD)
            if [ "$?" != "0" ]; then
              echo "‚ùå ERROR: Failed to get commit count"
              exit 1
            fi
            
            if ! [[ "$DEVELOP_COMMIT_COUNT" =~ ^[0-9]+$ ]]; then
              echo "‚ùå ERROR: Invalid commit count: $DEVELOP_COMMIT_COUNT"
              exit 1
            fi
            
            VERSION="${CURRENT_VERSION}-beta.${DEVELOP_COMMIT_COUNT}"
            echo "Develop version with prerelease suffix: $VERSION"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Publish Application
        shell: bash
        run: |
          echo "Publishing .NET application..."
          dotnet publish LolManager.csproj -c Release -o publish -r win-x64 --self-contained true
          
          if [ ! -d "publish" ]; then
            echo "‚ùå ERROR: Publish directory not created"
            exit 1
          fi
          
          if [ ! -f "publish/LolManager.exe" ]; then
            echo "‚ùå ERROR: LolManager.exe not found in publish directory"
            exit 1
          fi
          
          echo "‚úÖ Application published successfully"

      - name: Create Stable Release
        if: github.ref == 'refs/heads/master'
        shell: bash
        run: |
          echo "Creating stable release v${{ steps.get-version.outputs.version }}..."
          
          echo "Installing Velopack CLI..."
          dotnet tool install -g vpk
          if [ "$?" != "0" ]; then
            echo "‚ùå ERROR: Failed to install vpk tool"
            exit 1
          fi
          
          echo "Downloading existing releases..."
          vpk download github --repoUrl https://github.com/${{ github.repository }} --token ${{ secrets.GITHUB_TOKEN }}
          if [ "$?" != "0" ]; then
            echo "‚ö†Ô∏è  WARNING: Failed to download existing releases (this is OK for first release)"
          fi
          
          echo "Packing application..."
          vpk pack -u LolManager -v ${{ steps.get-version.outputs.version }} -p publish --channel stable
          if [ "$?" != "0" ]; then
            echo "‚ùå ERROR: Failed to pack application"
            exit 1
          fi
          
          echo "Uploading release to GitHub..."
          vpk upload github --repoUrl https://github.com/${{ github.repository }} --publish --releaseName "v${{ steps.get-version.outputs.version }} - –°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑" --tag v${{ steps.get-version.outputs.version }} --channel stable --token ${{ secrets.GITHUB_TOKEN }}
          if [ "$?" != "0" ]; then
            echo "‚ùå ERROR: Failed to upload release to GitHub"
            exit 1
          fi
          
          echo "Adding release notes and ensuring stable release settings..."
          sleep 3
          
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json; charset=utf-8" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/v${{ steps.get-version.outputs.version }}" \
            -d @- << 'EOF'
{
  "body": "## üéâ Stable Release\n\n### ‚ú® New Features and Improvements:\n- Enhanced application stability\n- Improved performance and loading speed\n- Fixed minor bugs and issues\n- Updated components for better compatibility\n\n### üîß Installation and Updates:\n- **New installation**: Download `LolManager-stable-Setup.exe`\n- **Updates**: Happen automatically\n\n---\nüí° *Want to get updates faster? Switch to beta channel in settings!*",
  "prerelease": false
}
EOF
          
          echo "‚úÖ Release notes added and stable release properly configured"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ stable —Ä–µ–ª–∏–∑ —Å—Ç–∞–ª latest
          sleep 2
          LATEST_RELEASE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
            jq -r '.tag_name')
          
          if [ "$LATEST_RELEASE" = "v${{ steps.get-version.outputs.version }}" ]; then
            echo "‚úÖ Stable release is latest: $LATEST_RELEASE"
          fi
          
          echo "‚úÖ Stable release created successfully"

      - name: Create Beta Release
        if: github.ref == 'refs/heads/develop'
        shell: bash
        run: |
          echo "Creating beta release v${{ steps.get-version.outputs.version }}..."
          
          echo "Installing Velopack CLI..."
          dotnet tool install -g vpk
          if [ "$?" != "0" ]; then
            echo "‚ùå ERROR: Failed to install vpk tool"
            exit 1
          fi
          
          echo "Downloading existing beta releases..."
          vpk download github --repoUrl https://github.com/${{ github.repository }} --channel beta --token ${{ secrets.GITHUB_TOKEN }}
          if [ "$?" != "0" ]; then
            echo "‚ö†Ô∏è  WARNING: Failed to download existing beta releases (this is OK for first beta release)"
          fi
          
          echo "Packing beta application..."
          vpk pack -u LolManager -v ${{ steps.get-version.outputs.version }} -p publish --channel beta
          if [ "$?" != "0" ]; then
            echo "‚ùå ERROR: Failed to pack beta application"
            exit 1
          fi
          
          vpk upload github --repoUrl https://github.com/${{ github.repository }} --publish --releaseName "v${{ steps.get-version.outputs.version }} - Beta —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" --tag v${{ steps.get-version.outputs.version }} --channel beta --token ${{ secrets.GITHUB_TOKEN }}
          
          # –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ pre-release
          sleep 5
          
          RELEASE_RESPONSE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/v${{ steps.get-version.outputs.version }}")
          
          RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq -r '.id')
          
          if [ "$RELEASE_ID" != "null" ] && [ "$RELEASE_ID" != "" ]; then
            curl -s -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json; charset=utf-8" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID" \
              -d @- > /dev/null << 'EOF'
{
  "body": "## Beta Version - Early Testing\n\n### Latest Improvements:\n- Added new features and capabilities\n- Improved existing component performance\n- Optimized application performance\n- Fixes based on user feedback\n\n### ‚ö†Ô∏è Important Information:\n- This is a test version for early access\n- Temporary bugs and issues are possible\n- Help improve the app - report issues!\n\n### üîß How to get beta versions:\n1. Open **Settings** in the application\n2. Change **Update Channel** to **beta**\n3. Restart and check for updates\n\n---\n‚ú® *Thanks for participating in testing! Your help makes the app better.*",
  "prerelease": true
}
EOF
            
            echo "‚úÖ Beta release marked as pre-release"
          else
            echo "‚ùå ERROR: Could not find release to mark as pre-release"
            exit 1
          fi
          
          echo "‚úÖ Beta release created successfully"
