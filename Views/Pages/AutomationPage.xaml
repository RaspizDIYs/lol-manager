<UserControl x:Class="LolManager.Views.Pages.AutomationPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:converters="clr-namespace:LolManager.Converters"
             x:Name="AutomationPageRoot">
    
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility"/>
        <converters:RunePagePreviewConverter x:Key="RunePagePreviewConverter"/>
        <converters:CollectionCountToVisibilityConverter x:Key="CollectionCountToVisibility"/>
        <!-- ItemTemplate для чемпионов с иконками -->
        <DataTemplate x:Key="ChampionTemplate">
            <StackPanel Orientation="Horizontal">
                <Border Width="28" 
                        Height="28" 
                        CornerRadius="14"
                        Margin="0,0,6,0"
                        VerticalAlignment="Center"
                        ClipToBounds="True">
                    <Image Source="{Binding Converter={StaticResource ChampionImageConverter}}" 
                           Stretch="UniformToFill"/>
                </Border>
                <TextBlock Text="{Binding}" 
                           VerticalAlignment="Center"
                           FontSize="12"/>
            </StackPanel>
        </DataTemplate>
        
        <!-- ItemTemplate для заклинаний с иконками -->
        <DataTemplate x:Key="SummonerSpellTemplate">
            <StackPanel Orientation="Horizontal">
                <Image Source="{Binding Converter={StaticResource SummonerSpellImageConverter}}" 
                       Width="22" 
                       Height="22" 
                       Margin="0,0,6,0"
                       VerticalAlignment="Center"/>
                <TextBlock Text="{Binding}" 
                           VerticalAlignment="Center"
                           FontSize="12"/>
            </StackPanel>
        </DataTemplate>
    </UserControl.Resources>
    
    <!-- Главный контейнер с ограничением области отображения -->
    <Border ClipToBounds="True">
        <Grid>
            <!-- Skeleton Loader - должен быть поверх основного контента -->
            <StackPanel Margin="16" 
                        HorizontalAlignment="Left" 
                        MaxWidth="550"
                        Panel.ZIndex="10"
                        Visibility="{Binding ElementName=AutomationPageRoot, Path=ViewModel.IsLoading, Converter={StaticResource BoolToVisibility}}">
            <ui:Card Margin="0,0,0,12" Padding="16">
                <StackPanel>
                    <Rectangle Height="28" RadiusX="4" RadiusY="4" Margin="0,0,0,8">
                        <Rectangle.Fill>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                <LinearGradientBrush.GradientStops>
                                    <GradientStop Color="#20FFFFFF" Offset="0"/>
                                    <GradientStop Color="#40FFFFFF" Offset="0.5"/>
                                    <GradientStop Color="#20FFFFFF" Offset="1"/>
                                </LinearGradientBrush.GradientStops>
                            </LinearGradientBrush>
                        </Rectangle.Fill>
                    </Rectangle>
                    <Rectangle Height="40" RadiusX="4" RadiusY="4" Margin="0,12,0,0" Fill="#10FFFFFF"/>
                    <Rectangle Height="40" RadiusX="4" RadiusY="4" Margin="0,8,0,0" Fill="#10FFFFFF"/>
                </StackPanel>
            </ui:Card>
            <ui:Card Padding="16">
                <StackPanel>
                    <Rectangle Height="20" Width="120" HorizontalAlignment="Left" RadiusX="4" RadiusY="4" Fill="#10FFFFFF" Margin="0,0,0,8"/>
                    <Rectangle Height="40" RadiusX="4" RadiusY="4" Fill="#10FFFFFF"/>
                    <Rectangle Height="40" RadiusX="4" RadiusY="4" Margin="0,8,0,0" Fill="#10FFFFFF"/>
                </StackPanel>
            </ui:Card>
        </StackPanel>
        
        <!-- Main Content -->
        <ScrollViewer VerticalScrollBarVisibility="Auto"
                      Panel.ZIndex="1"
                      Visibility="{Binding ElementName=AutomationPageRoot, Path=ViewModel.IsLoading, Converter={StaticResource InverseBoolToVisibility}}"
                      DataContext="{Binding ElementName=AutomationPageRoot, Path=ViewModel}">
            <StackPanel Margin="12" HorizontalAlignment="Left" MaxWidth="550">
                
                <!-- Заголовок -->
                <TextBlock Text="Автоматизация" 
                           FontSize="24" 
                           FontWeight="Bold" 
                           Margin="0,0,0,6"/>
                           
                <!-- Предупреждение -->
                <Border Background="{DynamicResource CardBackgroundFillColorDefaultBrush}" 
                        BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}" 
                        BorderThickness="1" 
                        CornerRadius="8" 
                        Padding="16"
                        Margin="0,0,0,16">
                    <StackPanel Orientation="Horizontal">
                        <Border Background="#FF6B35" 
                                CornerRadius="12" 
                                Width="24" 
                                Height="24" 
                                Margin="0,0,12,0"
                                VerticalAlignment="Top">
                            <TextBlock Text="!" 
                                       Foreground="White" 
                                       HorizontalAlignment="Center" 
                                       VerticalAlignment="Center" 
                                       FontWeight="Bold" 
                                       FontSize="14"/>
                        </Border>
                        <StackPanel>
                            <TextBlock Text="Функция в разработке" 
                                       FontWeight="SemiBold" 
                                       FontSize="14"
                                       Margin="0,0,0,4"/>
                            <TextBlock Text="Автоматизация ещё не идеально работает и могут быть проблемы. Используйте на свой страх и риск."
                                       FontSize="12" 
                                       TextWrapping="Wrap"
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
                
                <TextBlock Text="Настройте автоматический выбор чемпиона, бан, заклинания призывателя"
                           FontSize="12"
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                           TextWrapping="Wrap"
                           Margin="0,0,0,16"/>

                <!-- Включение автоматизации -->
                <ui:ToggleSwitch IsChecked="{Binding IsAutomationEnabled, Mode=TwoWay}" 
                                Content="Включить"
                                Margin="0,0,0,16"/>

                <!-- Задержка перед пиком -->
                <StackPanel Margin="0,0,0,16">
                    <CheckBox Content="Задержка перед пиком"
                              IsChecked="{Binding IsPickDelayEnabled, Mode=TwoWay}"
                              IsEnabled="{Binding IsAutomationEnabled}"/>
                    <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                        <Slider Minimum="0" Maximum="30" TickFrequency="1" IsSnapToTickEnabled="True"
                                Value="{Binding PickDelaySeconds, Mode=TwoWay}"
                                IsEnabled="{Binding IsAutomationEnabled}" Width="200"/>
                        <TextBlock Text="{Binding PickDelaySeconds}" Margin="8,0,0,0" VerticalAlignment="Center"/>
                        <TextBlock Text="сек" Margin="4,0,0,0" VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition/>
                        <ColumnDefinition/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition/>
                        <RowDefinition/>
                    </Grid.RowDefinitions>
                    
                    <!-- Поиск чемпиона -->
                    <ui:TextBox Text="{Binding ChampionSearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                IsEnabled="{Binding IsAutomationEnabled}"
                                PlaceholderText="🔍 Поиск чемпиона..."
                                Margin="0,0,0,6"
                                Grid.ColumnSpan="2"
                                Grid.Row="0"
                                Width="160"
                                HorizontalAlignment="Center"/>
                    
                    <!-- Автовыбор чемпиона -->
                    <StackPanel                         
                        Grid.Row="1"
                        Grid.Column="0"
                        Margin="0,0,8,0">
                        <TextBlock Text="Выбрать" 
                                   FontSize="14" 
                                   FontWeight="SemiBold" 
                                   Margin="0,0,0,6"/>
                        <ComboBox ItemsSource="{Binding FilteredChampionsForPick}" 
                                  SelectedItem="{Binding SelectedChampionToPick, Mode=TwoWay}"
                                  IsEnabled="{Binding IsAutomationEnabled}"
                                  MaxDropDownHeight="350"
                                  ItemTemplate="{StaticResource ChampionTemplate}"
                                  Margin="0,0,0,16">
                            <ComboBox.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <VirtualizingStackPanel/>
                                </ItemsPanelTemplate>
                            </ComboBox.ItemsPanel>
                        </ComboBox>
                    </StackPanel>
               
                    <!-- Автобан чемпиона -->
                    <StackPanel                  
                        Grid.Row="1"
                        Grid.Column="1">
                        <TextBlock Text="Забанить" 
                                   FontSize="14" 
                                   FontWeight="SemiBold" 
                                   Margin="0,0,0,6"/>
                        <ComboBox ItemsSource="{Binding FilteredChampionsForBan}" 
                                  SelectedItem="{Binding SelectedChampionToBan, Mode=TwoWay}"
                                  IsEnabled="{Binding IsAutomationEnabled}"
                                  MaxDropDownHeight="350"
                                  ItemTemplate="{StaticResource ChampionTemplate}"
                                  Margin="0,0,0,16">
                            <ComboBox.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <VirtualizingStackPanel/>
                                </ItemsPanelTemplate>
                            </ComboBox.ItemsPanel>
                        </ComboBox>
                    </StackPanel>
                </Grid>

                <!-- Заклинания призывателя -->
                
                <Grid Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <StackPanel Grid.Column="0">
                        <TextBlock Text="Заклинание 1" 
                                   FontSize="13" 
                                   FontWeight="SemiBold" 
                                   Margin="0,0,0,6"/>
                        <ComboBox ItemsSource="{Binding SummonerSpells}" 
                                  SelectedItem="{Binding SelectedSummonerSpell1, Mode=TwoWay}"
                                  ItemTemplate="{StaticResource SummonerSpellTemplate}"
                                  IsEnabled="{Binding IsAutomationEnabled}">
                        <ComboBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <VirtualizingStackPanel/>
                            </ItemsPanelTemplate>
                        </ComboBox.ItemsPanel>
                    </ComboBox>
                </StackPanel>
                
                <ui:Button Grid.Column="1"
                          Content="⇄"
                          FontSize="16"
                          Width="40"
                          VerticalAlignment="Bottom"
                          Margin="6,0,6,0"
                          Command="{Binding SwapSummonerSpellsCommand}"
                          IsEnabled="{Binding IsAutomationEnabled}"
                          ToolTip="Поменять местами"/>
                
                <StackPanel Grid.Column="2">
                    <TextBlock Text="Заклинание 2" 
                               FontWeight="SemiBold" 
                               FontSize="14" 
                               Margin="0,0,0,8"/>
                    <ComboBox ItemsSource="{Binding SummonerSpells}" 
                              SelectedItem="{Binding SelectedSummonerSpell2, Mode=TwoWay}"
                              ItemTemplate="{StaticResource SummonerSpellTemplate}"
                              IsEnabled="{Binding IsAutomationEnabled}">
                        <ComboBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <VirtualizingStackPanel/>
                            </ItemsPanelTemplate>
                            </ComboBox.ItemsPanel>
                        </ComboBox>
                    </StackPanel>
                </Grid>

                <!-- Руны -->
                <TextBlock Text="Страницы рун" 
                           FontSize="16" 
                           FontWeight="SemiBold" 
                           Margin="0,16,0,8"/>
            
                <ui:ToggleSwitch IsChecked="{Binding AutoRuneGenerationEnabled, Mode=TwoWay}" 
                                 Content="Автоматически создавать рекомендованную страницу рун"
                                 Margin="0,0,0,8"/>

                <Grid Margin="0,0,0,16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <ComboBox Grid.Column="0"
                          ItemsSource="{Binding RunePageNames}"
                          SelectedItem="{Binding SelectedRunePageName, Mode=TwoWay}"
                          IsEnabled="{Binding IsAutomationEnabled}"
                          Margin="0,0,8,0"/>

                <ui:Button Grid.Column="1"
                          Content="🎯 Применить"
                          Command="{Binding ApplySelectedRunePageCommand}"
                          IsEnabled="{Binding IsAutomationEnabled}"
                          Margin="0,0,8,0"
                          ToolTip="Применить выбранную страницу рун в клиенте LoL"/>

                <ui:Button Grid.Column="2"
                          Content="+ Создать"
                          Command="{Binding AddRunePageCommand}"
                          IsEnabled="{Binding IsAutomationEnabled}"/>
            </Grid>

            <ItemsControl ItemsSource="{Binding RunePages}"
                          Margin="0,0,0,16"
                          Visibility="{Binding RunePages, Converter={StaticResource CollectionCountToVisibility}}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <ui:Card Margin="0,0,0,6" Padding="10">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Превью рун -->
                                <ItemsControl Grid.Column="0"
                                              Margin="0,0,10,0"
                                              VerticalAlignment="Center">
                                    <ItemsControl.ItemsSource>
                                        <MultiBinding Converter="{StaticResource RunePagePreviewConverter}">
                                            <Binding Path="."/>
                                        </MultiBinding>
                                    </ItemsControl.ItemsSource>
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel MaxWidth="180"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Width="24"
                                                    Height="24"
                                                    Margin="2"
                                                    CornerRadius="12"
                                                    Background="#1E2328">
                                                <Image Source="{Binding Converter={StaticResource RuneImageConverter}}"
                                                       Width="20"
                                                       Height="20"
                                                       Stretch="UniformToFill"/>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                
                                <TextBlock Grid.Column="1"
                                          Text="{Binding Name}"
                                          VerticalAlignment="Center"
                                          FontSize="14"
                                          FontWeight="SemiBold"/>
                                
                                <StackPanel Grid.Column="2" Grid.ColumnSpan="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                    <ui:Button Content="✏️"
                                               Width="32"
                                               Height="32"
                                               Margin="4,0"
                                               Command="{Binding ElementName=AutomationPageRoot, Path=ViewModel.EditRunePageCommand}"
                                               CommandParameter="{Binding}"
                                               ToolTip="Редактировать"/>
                                    <ui:Button Content="🗑️"
                                               Width="32"
                                               Height="32"
                                               Margin="4,0"
                                               Command="{Binding ElementName=AutomationPageRoot, Path=ViewModel.DeleteRunePageCommand}"
                                               CommandParameter="{Binding}"
                                               ToolTip="Удалить"/>
                                </StackPanel>
                            </Grid>
                        </ui:Card>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
            
                <TextBlock Text="💾 Настройки сохраняются автоматически"
                           FontSize="11"
                           Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                           HorizontalAlignment="Left"/>
            </StackPanel>
        </ScrollViewer>
    </Grid>
    </Border>
</UserControl>
